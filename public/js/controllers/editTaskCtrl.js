angular
  .module("editTaskCtrl", ["editTaskService"])
  .controller("editTaskController", function($scope, editTask) {
    $scope.tagline = "This line generated by NerdCtrl.js";
    var new_task_modal = document.getElementById("task_modal");
    var add_btn = document.getElementById("add");
    $scope.new_task = {
      task_title: "",
      details: "",
      due_date: "",
      finish: false
    };
    add_btn.onclick = function() {
      new_task_modal.style.display = "block";
    };
    var new_task_close = document.getElementById("new_task_close");

    new_task_close.onclick = function() {
      new_task_modal.style.display = "none";
      $scope.new_task = {
        task_title: "",
        details: "",
        due_date: ""
      };
    };

    $scope.toDos = [
      {
        title: "Update Portfolio",
        details:
          "Projects part in personal website, personal website's font-end improvement",
        finish: false,
        due_date: Date.now()
      },
      {
        title: "Github daily update",
        details:
          "Keep coding everyday and update on github, improve efficiency",
        finish: false,
        due_date: Date.now()
      },
      {
        title: "Try out Angular2 and ReactJs on CodePen",
        details: "Try out Angular2 and ReactJs on CodePen",
        finish: false,
        due_date: Date.now()
      }
    ];

    $scope.removeToDo = function(toDo) {
      var index = $scope.toDos.indexOf(toDo);
      $scope.toDos.splice(index, 1);
      return editTask
        .delete(toDo)
        .success(function(results) {})
        .error(function(error) {
          console.log("removeToDo error: ", error);
        });
    };
    $scope.add_task = function(form_name) {
      if ($scope[form_name].$valid) {
        var due_date = angular
          .element("#due_date")
          .datepicker()
          .val();
        if (due_date) {
          due_date = new Date(due_date).getTime();
        } else {
          due_date = new Date().getTime();
        }
        $scope.new_task.due_date = due_date;
        return editTask
          .create(JSON.stringify($scope.new_task))
          .success(function(results) {
            new_task_modal.style.display = "none";
            $scope.new_task = {
              task_title: "",
              details: "",
              due_date: ""
            };
            getAllTasks();
          })
          .error(function(error) {
            console.log("create error: ", error);
          });
      }
    };
    function getAllTasks() {
      editTask
        .getAll()
        .success(function(results) {
          Object.keys(results).forEach(key => {
            $scope.toDos.push(results[key]);
          });
        })
        .error(function(error) {
          console.log("getalltasks error: ", error);
        });
    }
    getAllTasks();

    $scope.edit_task = {
      task_title: "",
      details: "",
      due_date: "",
      finish: false
    };
    var edit_task_modal = document.getElementById("edit_task_modal");
    $scope.updateToDo = function(task) {
      Object.keys(task).forEach(key => {
        $scope.edit_task[key] = task[key];
      });
      edit_task_modal.style.display = "block";
    };

    var edit_task_close = document.getElementById("edit_task_close");
    edit_task_close.onclick = function() {
      edit_task_modal.style.display = "none";
      $scope.edit_task = {
        task_title: "",
        details: "",
        due_date: "",
        finish: false
      };
    };

    $scope.update_task = function(task) {
      var updated_due_date = angular
        .element("#updated_due_date")
        .datepicker()
        .val();
      task.due_date = updated_due_date;
      return editTask
        .update(task)
        .success(function(results) {})
        .error(function(error) {
          console.log("update tasks error: ", error);
        });
    };

    $scope.finish = function(task) {
      task.finish = true;
      return editTask
        .update(task)
        .success(function(results) {})
        .error(function(error) {
          console.log("update tasks error: ", error);
        });
    };
  });
